<template>
  <div class="select-leader-vue mt-4" v-if="hasLeaders">

    <h2>Select your leader</h2>

    <form class="form-inline my-4">
      <label class="mr-4" for="soulstones">Soulstones: </label>
      <input type="text" class="form-control" v-model="soulstones">
    </form>

    <sortable-table
      :headers="tableHeaders"
      :data="tableData"
      v-on:selectedRow="selectLeader"
    ></sortable-table>

  </div>
</template>

<script lang="coffee">
  import SortableTable from '../Element/SortableTable.vue'

  SelectLeader =

    components: { SortableTable }

    props: [ 'masters', 'henchmen', 'factions' ]

    data: () ->
      soulstones: 50
      selectedLeader: null
      tableHeaders: ['Leader', 'Cache', 'Keywords']

    computed:

      hasLeaders: () -> @leaders.length > 0

      leaders: () ->
        out = []
        if @soulstones > 25 then @filterByFaction @masters, out
        if @soulstones < 40 then @filterByFaction @henchmen, out
        _.flatten out

      tableData: () ->
        _.map @leaders, (leader) =>
          [ leader.faction+":"+leader.name #ignored
          , @nameAndMaybeFaction(leader)
          , leader.cache
          , @listAttributes(leader.attributes, ', ')
          ]

    methods:

        selectLeader: (row) ->
          @selectedLeader = _.find @leaders, (x) ->
            x.faction+":"+x.name == row[0]
          @$emit "selectedLeader", @selectedLeader

        filterByFaction: (models, results) ->
          _.map models, (factiongroup, faction) =>
            if _.contains @factions, faction
              results.push factiongroup
            else
              results

        nameAndMaybeFaction: (model) ->
          dups = _.filter @leaders, (x) -> x.name == model.name
          if dups.length > 1
            model.name + ' (' + model.faction + ')'
          else
            model.name

        listAttributes: (atts, interp) ->
          _.reject atts, (x) ->
            x.substring(0,4) == "Wave" || x == "Master"
          .join interp

  export default SelectLeader
</script>

<style lang="sass">
  tr.selected td
    background-color: #ccc
</style>
